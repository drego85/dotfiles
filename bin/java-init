#!/usr/bin/env bash

# Copyright (C) 2018 Emanuele Petriglia <inbox@emanuelepetriglia.me>. All rights
# reserved. This file is licensed under the MIT license.

# This script allows to create simple skeleton projects for Java using Gradle.
# For more informations run the script with '--help' as argument.

set -e

#
# BEGIN global variables
#

PROGRAM="${0##*/}"

# Last part of folder path.
LAST_FOLDER="${PWD##*/}"

#
# BEGIN helper functions
#

# Prints all arguments given as arguments and exits with error code 1.
error() {
  echo "$@" >&2
  exit 1
}

#
# BEGIN subcommand functions
#

# Shows a proper error message and quits with error code -1.
cmd_error() {
  local option="$1"

  if [[ -z "$1" ]]; then
    error "No option given. Try '$PROGRAM help' for a list of options."
  else
    error "Unrecognized option: $option"
  fi
}

# Shows help informations.
cmd_usage() {
  cat <<-_EOF
Usage:
    $PROGRAM application folder
        Creates a skeleton of a Java application project (it has a main class).
        You can specify a folder on which the project will be boostrapped,
        otherwise it will done on the current position.
    $PROGRAM library folder
        Create a skeleton of a Java library project.
        You can specify a folder on which the project will be boostrapped,
        otherwise it will done on the current position.
    $PROGRAM help
        Shows this text.

Gradle build system is used. It must be installed, it is not important which
version, because 'gradle wrapper' task is used to download and use the latest
version.
_EOF
}

# Bootstraps a Java template with Gradle as build system. The user can specify
# two types of Java projects (application and library), and can optionally
# specify a folder on which the project will be bootstrapped.
apply_template() {
  if [[ -z $(which gradle) ]]; then
    error "No Gradle binary found"
  fi

  TYPE="$1"

  # Allows to give a custom folder.
  local folder="$2"
  if [[ -n "$folder" ]]; then
    LAST_FOLDER="$folder"

    if [[ -d "$LAST_FOLDER" ]]; then
      error "'$LAST_FOLDER' directory already exist."
    fi

    mkdir --parents $LAST_FOLDER
    cd $LAST_FOLDER
  fi

  gradle wrapper --gradle-version 4.6 1>>/dev/null

  mkdir --parents "src/main/java"
  mkdir --parents "src/test/java"

  cp "$HOME/.gradle/templates/$TYPE/build.gradle" "build.gradle"
  cp "$HOME/.gradle/templates/$TYPE/settings.gradle" "settings.gradle"

  sed -i -e "s/PROJECTNAME/$LAST_FOLDER/g" settings.gradle
}

if [[ -z "$HOME" ]]; then
  if [[ -z "$(which xdg-user-dir)" ]]; then
    error "Can't extabilish home directory"
  else
    HOME="$(xdg-user-dir)"
  fi
fi

COMMAND="$1"

case "$1" in
  application) shift;   apply_template "java-application" "$@" ;;
  library) shift;       apply_template "java-library" "$@" ;;
  help|--help)          cmd_usage ;;
  *)                    cmd_error "$1" ;;
esac

exit 0
