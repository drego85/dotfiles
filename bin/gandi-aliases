#!/usr/bin/env bash
#
# This script is useful to manage aliases for my email address and domain,
# "inbox@emanuelepetriglia.com".
#
# Use '-h' or '--help' option to get usage information. This script requires:
#   - pass: to get private api key;
#   - curl: to send and get api requests;
#   - jq: to manage JSON data.
#
# Copyright (c) 2019 Emanuele Petriglia <inbox@emanuelepetriglia.com>
# All right reserved. This file is licensed under the MIT license.

readonly DOMAIN="emanuelepetriglia.com"
readonly EMAIL="inbox@$DOMAIN" # Used in output messages.
readonly BASE_ENDPOINT="https://api.gandi.net/v5/email/mailboxes/$DOMAIN/"

readonly CURL_OPTS="--silent --show-error"

# Unit of time before checking if an alias is added or removed. it is necessary
# because changes are not immediate.
readonly WAITING="5s"

#
# BEGIN helper functions
#

# It prints all arguments to the standard error and exits with error code 1.
error() {
  echo "$@" >&2
  exit 1
}

# It set '$API_KEY' and '$ENDPOINT' readonly variables to send requests to Gandi.
# If they are already set, do nothing.
get_sensible_data() {
  [[ -z "$API_KEY" ]] && readonly API_KEY="$(pass shop/gandi.net | sed '5p;d')"
  [[ "$API_KEY" ]] || error "Failet to get api key."

  if [[ -z "$ENDPOINT" ]]; then
    local email_id="$(pass email/inbox@emanuelepetriglia.com | sed '4p;d')"
    [[ "$email_id" ]] || error "Failed to get email id."

    readonly ENDPOINT="$BASE_ENDPOINT$email_id"
  fi
}

# Print to the standard output aliases list for '$EMAIL' as JSON array. It uses
# '$ENDPOINT' and '$API_KEY'. If it fails, it will exit with error code 1.
get_aliases_list() {
  get_sensible_data

  local data
  data="$(curl $CURL_OPTS -X GET "$ENDPOINT" \
               --header "authorization: apikey $API_KEY" 2>&1)"

  [[ "$?" != "0" ]] && error "Failed to get GET reponse: $data"

  aliases="$(echo "$data" | jq '.aliases')"

  [[ "$aliases" == "null" ]] && error "Failed to get email aliases: $data"

  echo "$aliases"
}

# Update aliases list for email '$EMAIL', sending the updated JSON array using
# '$ENDPOINT' and '$API_KEY'. If it fails it will exit with error code 1.
#
# Parameter:
#   $1  - JSON aliases list.
#
send_aliases_list() {
  [[ "$1" ]] || error "No aliases list given."
  local alias_list="$(echo "$1" | jq '{ aliases: . }')"

  get_sensible_data

  local reponse
  response="$(curl $CURL_OPTS -X PATCH "$ENDPOINT" \
                   --header "authorization: apikey $API_KEY" \
                   --header "content-type: application/json" \
                   --data "$alias_list" 2>&1)"

  [[ "$?" != "0" ]] && error "Failed to send aliases list: $response"

  [[ "$(echo "$response" | grep "error")" ]] \
    && error "Failed to update aliases list: $response"
}

# It locally update a given JSON aliases list, then it prints the list to the
# standard output. It can remove an alias or add an alias. If it fails, it will
# exit with error code 1.
#
# Parameters:
#   $1  - JSON alias list;
#   $2  - Alias to add or remove;
#   $3  - Add ('add') or remove ('remove') the alias.
#
update_aliases_list() {
  [[ "$1" ]] || error "No aliases list given."
  [[ "$2" ]] || error "No alias given."
  [[ "$3" && "$3" == "add" || "$3" == "remove" ]] \
    || error "No command given ('add' or 'remove')."

  local alias_list="$1"
  local alias="$2"
  local command="$3"
  local operation

  if [[ "$command" == "add" ]]; then
    [[ "$(echo "$alias_list" | grep "\"$alias\"")" ]] \
      && error "Alias '$alias' already exist."

    operation="+="
  else
    [[ "$(echo "$alias_list" | grep "\"$alias\"")" ]] \
      || error "Alias '$alias' doesn't exist."

    operation="-="
  fi

  echo "$alias_list" | jq --monochrome-output ". $operation [\"$alias\"]"
}

manage_alias() {
  [[ "$1" && "$1" == "add" || "$1" == "remove" ]] \
    || error "No command given ('add' or 'remove')."
  [[ "$2" ]] || error "No alias given."

  local cmd="$1"
  local alias="$2"

  local list
  list="$(get_aliases_list)"
  [[ "$?" == "0" ]] || error "$list"

  list="$(update_aliases_list "$list" "$alias" "$cmd")"
  [[ "$?" == "0" ]] || error "$list"

  send_aliases_list "$list"
}

#
# END helper functions
#

#
# BEGIN subcommand functions
#

# It shows usage informations.
cmd_help() {
  cat <<-_EOF
Usage:
    $PROGRAM [-g|--get]
    $PROGRAM [-a|--add] <alias>
    $PROGRAM [-r|--remove] <alias>

  If no options are given, the default option is '--help'. Both commands retrive
  the Gandi API key using 'pass'm to add and get aliases.

  This is a custom script, so it is tailored for my needings. Infact it uses
  'pass' to retrivere API key and my email is hardcoded in the script.

Available options:
    -g, --get
        Retrieve the email aliases for '$EMAIL' and print
        them to stdout.

    -a, --add=alias
        Add new alias for '$EMAIL'. It fails if the given
        alias is invalid or is a duplicate.

    -r, --remove=alias
        Remove an alias from '$EMAIL'. It fails if the
        given alias doesn't exist.

    -c, --check=alias
        Check if an alias exist for '$EMAIL'.

    -h, --help
        Show this message and exit.

This script uses 'curl' and 'jq', they must be installed on the system.
_EOF
}


# Print to the standard output the JSON aliases list.
cmd_get() {
  get_aliases_list
}

# Add one alias. If the alias is a duplicate or is invalid, it will fail.
cmd_add() {
  manage_alias "add" "$@"
}

# Remove one alias. If the alias doesn't exist, it will fail.
cmd_remove() {
  manage_alias "remove" "$@"
}

cmd_check() {
  [[ "$1" ]] || error "No alias given."
  local alias="$1"

  local alias_list
  alias_list="$(get_aliases_list)"
  [[ "$?" == "0" ]] || error "$alias_list"

  if [[ "$(echo "$alias_list" | grep "\"$alias\"")" ]]; then
      echo "Alias '$alias' exist."
  else
      echo "Alias '$alias' doesn't exist."
  fi
}

#
# END subcommands functions
#

PROGRAM="${0##*/}"
COMMAND="$1"

case "$1" in
  -h|--help) shift;   cmd_help "$@" ;;
  -g|--get) shift;    cmd_get "$@" ;;
  -a|--add) shift;    cmd_add "$@" ;;
  -r|--remove) shift; cmd_remove "$@" ;;
  -c|--check) shift;  cmd_check "$@" ;;
  *) shift;           cmd_help "$@" ;;
esac

exit 0
