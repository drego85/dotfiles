#!/usr/bin/env bash
#
# This script logins automatically to the Sapienza's WiFi network, without open
# a broswer and insert manually the username and password.
#
# This script requires these programs:
#   - wget: to do the connection (POST);
#   - mktemp: to store temporary file during the login;
#   - notify-sent: to send notification about the login/logout operation.
#   - pass (optional): to retrieve the password.
#
# I use `pass` to manage and store password, but you can insert your password
# with the global variable `PASSWORD`.
#
# TODO:
#   - Add error handling.
#
# Copyright (c) 2019 Emanuele Petriglia <inbox@emanuelepetriglia.com>
# All right reserved. This file is licensed under the MIT license.

# Login URL.
URL="https://wifi-cont1.uniroma1.it:8003/index.php?zone=wifi_sapienza"

# Location of the password in the password store database.
PASSWORD_LOCATION="university/uniroma1.it"

# Login details.
USERNAME="1798177"
#PASSWORD="" # The password is retrieved only when login command is given.

# Path and name of the file with logout ID, used to logout.
LOGOUT_ID_FILE="/tmp/sapienza-wifi-logout-id"

#
# BEGIN helper functions
#

# It prints all arguments to the standard error and exits with error code 1.
error() {
  echo "$@" >&2
  exit 1
}

#
# END helper functions
#

#
# BEGIN subcommand functions
#

# It shows usage informations.
cmd_help() {
  cat <<-_EOF
Usage:
    $PROGRAM <command>

  If no command is given, the default command is 'login'.

Available commands:
    login
        It connects to Sapienza's Wifi network, using the username and password
        coded in the script (the password is retrieved with 'pass').

    logout
        It disconnects from Sapienza's Wifi network.

    check
        It prints "connected" or "disconnected" if there is an Internet
        connection. By default is tries to connect to Sapienza's Web home page.

This script uses 'wget', 'mktemp', 'notify-send' and 'pass', they must be
installed on the system.

For more informations read the header of this script.
_EOF
}

# It prints to the standard output "conncted" or "disconnected" if there is an
# Internet connection or not.
cmd_check_network() {
  local test_page="https://www.uniroma1.it/"

  wget --quiet --spider "$test_page"
  local result=$?

  if [[ $result -eq 0 ]]; then
    echo "connected"
  else
    echo "disconnected"
  fi
}

# It logins to the Sapienza's Wifi network, using the username and the password.
# It also save in a temporary file the logout ID, it will be used to logout.
cmd_login() {
  local login_url="https://wifi-cont1.uniroma1.it:8003/index.php?zone=wifi_sapienza"

  # POST parameters.
  local auth_user="auth_user=$USERNAME"
  local auth_pass="auth_pass=$(pass $PASSWORD_LOCATION | head -n 1)"
  local zone="zone=wifi_sapienza"
  local redirurl="redirurl=wifi_sapienza"
  local accept="accept=Accetto+-+Accept"

  local data="$auth_user&$auth_pass&$zone&$redirurl&$accept"

  # Temporary file to store HTML result of the request.
  local html_result="$(mktemp)"

  wget --output-document="$html_result" --quiet --post-data "$data" "$login_url"

  # Extract the logout ID from the HTML response.
  # It filters the 17th line (the one with login ID), then extracts all words
  # and the last is the ID.
  cat "$html_result" | sed -n 17p | grep -oE '[[:alnum:]]+' | \
                                                     tail -n 1 > $LOGOUT_ID_FILE

  rm "$html_result"

  if [[ $(cmd_check_network) != "connected" ]]; then
    notify-send --icon=network-error "Sapienza's Wifi" "Failed to login"
    error "Failed to login"
  fi

  notify-send --icon=network-wireless "Sapienza's WiFi" "Logged"
}

# It logouts from the Sapienza's Wifi network. It uses the ID provided by the
# login function.
cmd_logout() {
  local logout_url="https://wifi-cont1.uniroma1.it:8003/"

  # POST parameters.
  local logout_id="logout_id=$(cat $LOGOUT_ID_FILE)"
  local zone="zone=wifi_sapienza"
  local logout_command="logout=Logout"

  local data="$logout_id&$zone&$logout_command"

  wget --quiet --output-document /dev/null --post-data "$data" "$logout_url"

  if [[ $(cmd_check_network) != "disconnected" ]]; then
    notify-send --icon=network-error "Sapienza's Wifi" "Failed to logout"
    error "Failed to logout"
  fi

  notify-send --icon=notification-network-wireless-disconnected \
    "Sapienza's WiFi" "Logout"
}

#
# END subcommands functions
#

PROGRAM="${0##*/}"
COMMAND="$1"

case "$1" in
  login)                cmd_login ;;
  logout)               cmd_logout ;;
  check)                cmd_check_network ;;
  help)                 cmd_help ;;
  *) COMMAND="login";   cmd_login ;;
esac

exit 0
